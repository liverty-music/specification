name: 'ðŸ”€ Gemini Dispatch'

on:
  pull_request_review_comment:
    types: ['created']
  pull_request_review:
    types: ['submitted']
  pull_request:
    types: ['opened']
  issue_comment:
    types: ['created']
  issues:
    types: ['opened']

jobs:
  dispatch:
    if: github.event.sender.type != 'Bot'
    runs-on: 'ubuntu-latest'
    outputs:
      command: '${{ steps.dispatch.outputs.command }}'
      prompt: '${{ steps.dispatch.outputs.prompt }}'
      additional_context: '${{ steps.dispatch.outputs.additional_context }}'
    steps:
      - name: 'Run Gemini Dispatcher'
        id: 'dispatch'
        uses: 'google-github-actions/run-gemini-cli@v0.1.19'
        with:
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          command: 'dispatch'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN || github.token }}'

      - name: 'Acknowledge request'
        if: steps.dispatch.outputs.command != 'fallthrough' && steps.dispatch.outputs.command != ''
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN || github.token }}'
          ISSUE_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– I've received your request and I'm working on it! [Tracking Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

  review:
    needs: 'dispatch'
    if: needs.dispatch.outputs.command == 'review'
    uses: './.github/workflows/gemini-review.yml'
    secrets: inherit
    with:
      additional_context: '${{ needs.dispatch.outputs.additional_context }}'

  invoke:
    needs: 'dispatch'
    if: needs.dispatch.outputs.command == 'invoke'
    uses: './.github/workflows/gemini-invoke.yml'
    secrets: inherit
    with:
      prompt: '${{ needs.dispatch.outputs.prompt }}'
      additional_context: '${{ needs.dispatch.outputs.additional_context }}'
